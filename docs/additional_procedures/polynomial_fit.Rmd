---
title: "Polynomial Fit"
author: "Tecla Duran Fort"
date: "`r Sys.Date()`"
output:
  github_document:
    toc: true
    toc_depth: 3
    md_extensions: +raw_html
  pdf_document:
    toc: yes
    toc_depth: 3
  html_document:
    
    toc: yes
    toc_depth: 3
    number_sections: true
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.path = "figures_summary/",
  dpi = 600
)

library(dplyr)
library(ggplot2)
library(tidyr)
library(purrr)

source("../../load_harmonization_tools.R")


analyte_colors <- c(
  anisole   = "navy",
  heptanone = "#E0711A"
)

```

```{r, echo=FALSE}
path <- "../../data/tables"

files <- list.files(path, pattern = "\\.csv$", full.names = TRUE)

for (f in files) {
  name <- tools::file_path_sans_ext(basename(f))
  assign(name, read.csv(f))
}

su <- shift_to_origin(su, analytes = c("anisole", "heptanone"))$data
```


```{r, echo=FALSE}
analytes <- c("anisole", "heptanone")
```

```{r}
fit_polynomials <- function(df, analytes, conc_col = "concentration",
                            degree = 3, intercept = FALSE) {
  
  coef_table <- tibble()
  metrics_table <- tibble()
  models <- list()
  
  for (analyte in analytes) {
    
    # detect shifted concentration
    conc_shifted <- paste0("c_", analyte)
    use_shifted <- conc_shifted %in% names(df)
    concentration_var <- ifelse(use_shifted, conc_shifted, conc_col)
    
    # build df
    tmp <- df %>%
      dplyr::select(all_of(concentration_var), all_of(analyte)) %>%
      dplyr::rename(
        concentration = all_of(concentration_var),
        intensity = all_of(analyte)
      )
    
    # formula
    if (intercept) {
      form <- as.formula(paste0("intensity ~ poly(concentration, ", degree, ", raw = TRUE)"))
    } else {
      form <- as.formula(paste0("intensity ~ poly(concentration, ", degree, ", raw = TRUE) - 1"))
    }
    
    # fit model
    fit <- lm(form, data = tmp)
    sfit <- summary(fit)
    
    # metrics essentials
    R2 <- sfit$r.squared
    adjR2 <- sfit$adj.r.squared
    RSE <- sfit$sigma
    RSS <- sum(fit$residuals^2)
    
    # save model
    models[[analyte]] <- fit
    
    # coefficients row
    cf <- coef(fit)
    coef_row <- tibble(
      Analyte = display_name(analyte),
      a0 = ifelse(intercept, cf[1], 0),
      a1 = cf[ifelse(intercept, 2, 1)],
      a2 = cf[ifelse(intercept, 3, 2)],
      a3 = cf[ifelse(intercept, 4, 3)]
    )
    coef_table <- bind_rows(coef_table, coef_row)
    
    # metrics row
    metrics_row <- tibble(
      Analyte = analyte,
      R2 = R2,
      adjR2 = adjR2,
      RSE = RSE,
      RSS = RSS
    )
    metrics_table <- bind_rows(metrics_table, metrics_row)
  }
  
  return(list(
    coef_table = coef_table,
    metrics_table = metrics_table,
    models = models
  ))
}


```

```{r}
res_poly <- fit_polynomials(su, analytes)

coef_poly <- res_poly$coef_table
metrics_poly <- res_poly$metrics_table
models_list <- res_poly$models
```

```{r}
plot_polynomial_fits <- function(df, models_list) {
  
  for (analyte in names(models_list)) {
    
    fit <- models_list[[analyte]]
    cf <- coef(fit)
    
    # detect concentration variable
    conc_shifted <- paste0("c_", analyte)
    concentration_var <- ifelse(conc_shifted %in% names(df), conc_shifted, "concentration")
    
    tmp <- df %>%
      dplyr::select(all_of(concentration_var), all_of(analyte)) %>%
      dplyr::rename(
        concentration = all_of(concentration_var),
        intensity = all_of(analyte)
      )
    
    grid <- seq(min(tmp$concentration), max(tmp$concentration), length.out = 200)
    preds <- predict(fit, newdata = data.frame(concentration = grid))
    
    # equation text
    a0 <- ifelse("(Intercept)" %in% names(cf), cf[1], 0)
    a1 <- cf[ifelse("(Intercept)" %in% names(cf), 2, 1)]
    a2 <- cf[ifelse("(Intercept)" %in% names(cf), 3, 2)]
    a3 <- cf[ifelse("(Intercept)" %in% names(cf), 4, 3)]
    
    eq_text <- sprintf("f(C) = %.3f + %.3f·C + %.3f·C² + %.3f·C³",
                       a0, a1, a2, a3)
    
    p <- ggplot2::ggplot() +
      ggplot2::geom_point(
        data = tmp,
        aes(x = concentration, y = intensity),
        color = "black", size = 2
      ) +
      ggplot2::geom_line(
        data = tibble(concentration = grid, intensity = preds),
        aes(x = concentration, y = intensity),
        color = "navy", size = 1
      ) +
      ggplot2::annotate(
        "text",
        x = min(tmp$concentration),
        y = max(tmp$intensity),
        label = eq_text,
        hjust = 0, vjust = 1, size = 5,
        color = "navy"
      ) +
      ggplot2::labs(
        title = display_name(analyte),
        x = "Concentration",
        y = "Intensity"
      ) +
      ggplot2::theme_minimal()+
      ggplot2::theme_minimal(base_size = 14) +  
      ggplot2::theme(
        plot.title = ggplot2::element_text(
          hjust = 0.5,      
          face = "bold",      
          size = 16   
        ))
    
    print(p)
  }
}

```

```{r}
plot_polynomial_fits(su, models_list)

```
# Polynomial Degree Election


```{r}
degrees <- 1:5

for (analyte in analytes) {
  
  # Detectar concentració corregida
  conc_var <- ifelse(paste0("c_", analyte) %in% colnames(su),
                     paste0("c_", analyte),
                     "concentration")
  
  tmp <- su %>%
    select(all_of(conc_var), all_of(analyte)) %>%
    rename(concentration = all_of(conc_var),
           intensity     = all_of(analyte))
  
  df_res <- map_df(degrees, function(deg) {
    fit <- lm(intensity ~ poly(concentration, deg, raw = TRUE) - 1, data = tmp)
    s   <- summary(fit)
    tibble(Degree = deg, R2 = s$r.squared, RSE = s$sigma)
  })
  
  max_RSE <- max(df_res$RSE)
  scale_factor <- max_RSE / 1
  
  col_an <- analyte_colors[analyte]

  df_plot <- df_res %>%
    mutate(
      R2_plot  = R2,         
      
      RSE_plot = RSE / max(RSE)   
      
    )
  
  p <- ggplot(df_plot, aes(x = Degree)) +
  
    geom_line(aes(y = RSE_plot), 
              color = col_an, linewidth = 1.5) +
    geom_point(aes(y = RSE_plot), 
               color = col_an, size = 3) +
  
  
    geom_line(aes(y = R2_plot), 
              color = adjustcolor(col_an, alpha.f = 0.35), linewidth = 1.5) +
    geom_point(aes(y = R2_plot), 
               color = adjustcolor(col_an, alpha.f = 0.35), size = 3) +
  
    scale_y_continuous(
      name = "R²",
      limits = c(0, 1),
      sec.axis = sec_axis(
        ~ . * max(df_res$RSE),
        name = "Residual Std. Error"
      )
    ) +
  
    labs(
      title = paste("Model complexity vs fit quality —", display_name(analyte)),
      x = "Polynomial degree"
    ) +
  
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      legend.position = "none",
      axis.title.y = element_text(
        color = adjustcolor(col_an, alpha.f = 0.35),
        face = "bold"
      ),
      axis.title.y.right = element_text(
        color = col_an,
        face = "bold"
      )
    )
  
  print(p)
}




```
## Cross Validation 

```{r}
degrees <- 1:4

cv_results <- purrr::map_df(analytes, function(analyte) {

# Detect concentration variable

conc_var <- ifelse(paste0("c_", analyte) %in% colnames(su),
paste0("c_", analyte),
"concentration")

# Build dataset

tmp <- su %>%
dplyr::select(all_of(conc_var), all_of(analyte)) %>%
dplyr::rename(
concentration = all_of(conc_var),
intensity     = all_of(analyte)
)

conc_levels <- sort(unique(tmp$concentration))

purrr::map_df(degrees, function(deg) {
  purrr::map_df(conc_levels, function(cl) {
  
    train <- tmp %>% dplyr::filter(concentration != cl)
    test  <- tmp %>% dplyr::filter(concentration == cl)
    
    # Fit without this concentration level
    fit <- lm(intensity ~ poly(concentration, deg, raw = TRUE) - 1,
              data = train)
    
    # Predict on held-out concentration
    pred <- predict(fit, newdata = test)
    
    rmse <- sqrt(mean((test$intensity - pred)^2))
    
    tibble(
      Analyte = analyte,
      Degree  = deg,
      Conc_left_out = cl,
      RMSE = rmse
    )
    })
  })
})

# Summarise RMSE per analyte and degree

cv_summary <- cv_results %>%
dplyr::group_by(Analyte, Degree) %>%
dplyr::summarise(
RMSE_mean = mean(RMSE),
RMSE_sd   = sd(RMSE),
.groups   = "drop"
) %>%
dplyr::mutate(Analyte_label = Analyte)

# Show table

knitr::kable(
cv_summary %>%
dplyr::select(Analyte_label, Degree, RMSE_mean, RMSE_sd),
col.names = c("Analyte", "Degree", "Mean RMSE", "SD RMSE"),
digits = 4,
caption = "Cross-validation: leave-one-concentration-out RMSE by polynomial degree"
)

```

```{r, fig.width=10}
ggplot(cv_summary, aes(x = Degree, y = RMSE_mean,
color = Analyte_label, group = Analyte_label)) +

geom_line(linewidth = 1.1) +
geom_point(size = 3) +
geom_errorbar(aes(ymin = RMSE_mean - RMSE_sd,
ymax = RMSE_mean + RMSE_sd),
width = 0.15) +

facet_wrap(~ Analyte_label, scales = "free_y") +

scale_color_manual(values = analyte_colors) +

labs(
title    = "Leave-one-concentration-out cross-validation",
subtitle = "Prediction RMSE for each polynomial degree",
x        = "Polynomial degree",
y        = "RMSE"
) +

theme_minimal(base_size = 14) +
theme(
plot.title   = element_text(size = 16, face = "bold", hjust = 0.5),
plot.subtitle= element_text(hjust = 0.5)
)


```

